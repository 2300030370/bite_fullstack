# ========================
# MYSQL DEPLOYMENT + SERVICE (FIXED)
# ========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bite-mysql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bite-mysql
  template:
    metadata:
      labels:
        app: bite-mysql
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
      env:
            - name: MYSQL_ROOT_PASSWORD
              value: root
            - name: MYSQL_DATABASE
              value: bite_data
      ports:
            - containerPort: 3306
      volumeMounts:
            - name: mysql-storage
              mountPath: /var/lib/mysql

      volumes:
        - name: mysql-storage
          persistentVolumeClaim:
            claimName: mysql-pvc


---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: bite-mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: hostpath   # Docker Desktop default
  resources:
    requests:
      storage: 5Gi


---
apiVersion: v1
kind: Service
metadata:
  name: bite-mysql
spec:
  selector:
    app: bite-mysql
  ports:
    - port: 3306
      targetPort: 3306

# ========================
# BACKEND DEPLOYMENT + SERVICE
# ========================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bite-backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: bite-backend
  template:
    metadata:
      labels:
        app: bite-backend
    spec:

      # Wait for MySQL to be ready
      initContainers:
        - name: wait-for-mysql
          image: alpine:3.18
          command:
            - sh
            - -c
            - |
              apk add --no-cache netcat-openbsd
              until nc -z bite-mysql 3306; do
                echo waiting for mysql
                sleep 3
              done

      containers:
        - name: backend
          image: hari305/cicd_biteproject_backend:v1
          ports:
            - containerPort: 8081
          env:
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://bite-mysql:3306/bite_data
            - name: SPRING_DATASOURCE_USERNAME
              value: root
            - name: SPRING_DATASOURCE_PASSWORD
              value: root
            - name: SPRING_JPA_HIBERNATE_DDL_AUTO
              value: update
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8081
            initialDelaySeconds: 20
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8081
            initialDelaySeconds: 40
            periodSeconds: 10

# ========================
# FRONTEND DEPLOYMENT + SERVICE
# ========================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bite-frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bite-frontend
  template:
    metadata:
      labels:
        app: bite-frontend
    spec:
      containers:
        - name: frontend
          image: hari305/cicd_biteproject_frontend:v1
          ports:
            - containerPort: 80
          env:
            - name: REACT_APP_BACKEND_URL
              value: http://bite-backend:8081

---
apiVersion: v1
kind: Service
metadata:
  name: bite-frontend
spec:
  type: NodePort
  selector:
    app: bite-frontend
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
